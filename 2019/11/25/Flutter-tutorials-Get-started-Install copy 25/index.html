<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Cách mạng 0.4 của Neovim: Floating Window | ToanDN Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Cách mạng 0.4 của Neovim: Floating WindowTrước khi bắt đầu: Nếu vì lý do gì đó mà bạn quyết định không đọc bài viết này vì bạn đang xài VSCode và thấy nó đủ xịn với bạn rồi, thì hãy suy nghĩ lại, đọc">
<meta name="keywords" content="Injury,Fight,Shocking">
<meta property="og:type" content="article">
<meta property="og:title" content="Cách mạng 0.4 của Neovim: Floating Window">
<meta property="og:url" content="toandn96.github.io&#x2F;2019&#x2F;11&#x2F;25&#x2F;Flutter-tutorials-Get-started-Install%20copy%2025&#x2F;index.html">
<meta property="og:site_name" content="ToanDN Blog">
<meta property="og:description" content="Cách mạng 0.4 của Neovim: Floating WindowTrước khi bắt đầu: Nếu vì lý do gì đó mà bạn quyết định không đọc bài viết này vì bạn đang xài VSCode và thấy nó đủ xịn với bạn rồi, thì hãy suy nghĩ lại, đọc">
<meta property="og:locale" content="vi">
<meta property="og:image" content="https:&#x2F;&#x2F;thefullsnack.com&#x2F;posts&#x2F;img&#x2F;vim-float-term&#x2F;demo.gif">
<meta property="og:image" content="https:&#x2F;&#x2F;thefullsnack.com&#x2F;posts&#x2F;img&#x2F;vim-float-term&#x2F;layout.png">
<meta property="og:image" content="https:&#x2F;&#x2F;thefullsnack.com&#x2F;posts&#x2F;img&#x2F;vim-float-term&#x2F;first-implementation.png">
<meta property="og:image" content="https:&#x2F;&#x2F;thefullsnack.com&#x2F;posts&#x2F;img&#x2F;vim-float-term&#x2F;border-layout.png">
<meta property="og:image" content="https:&#x2F;&#x2F;thefullsnack.com&#x2F;posts&#x2F;img&#x2F;vim-float-term&#x2F;border-bug.gif">
<meta property="og:image" content="https:&#x2F;&#x2F;thefullsnack.com&#x2F;posts&#x2F;img&#x2F;vim-float-term&#x2F;final.gif">
<meta property="og:updated_time" content="2019-11-26T03:11:18.461Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;thefullsnack.com&#x2F;posts&#x2F;img&#x2F;vim-float-term&#x2F;demo.gif">
  
    <link rel="alternate" href="/atom.xml" title="ToanDN Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <!-- <header id="header">
  <div id="header-outer" class="outer"> -->
    <!-- <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">ToanDN Blog</a>
      </h1>
      
    </div> -->
    <!-- <div id="header-home">
      <picture>
        <a href="/">
          <img class="img-header"
            src="https://www.lyyourc.com/static/60b519c78e732596dffdeeec7c23be4b/731cb/avatar.png" />
        </a>
      </picture>
    </div>

  </div> -->
<!-- </header> -->
      <div class="outer">
        <section id="main"><article id="post-Flutter-tutorials-Get-started-Install copy 25" class="article article-type-post" itemscope
  itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/25/Flutter-tutorials-Get-started-Install%20copy%2025/" class="article-date">
  <time datetime="2019-11-25T10:22:39.000Z" itemprop="datePublished">2019-11-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Sports/">Sports</a>,<a class="article-category-link" href="/categories/Sports/Baseball/">Baseball</a>
  </div>

  </div>
  <div class="article-inner">
    
    
    <header class="article-header">
      
      
  
    <h1 class="article-title" itemprop="name">
      Cách mạng 0.4 của Neovim: Floating Window
    </h1>
  

      
    </header>
    
    
    <div class="article-entry" itemprop="articleBody">
      
      
      <h1 id="Cach-mang-0-4-cua-Neovim-Floating-Window"><a href="#Cach-mang-0-4-cua-Neovim-Floating-Window" class="headerlink" title="Cách mạng 0.4 của Neovim: Floating Window"></a>Cách mạng 0.4 của Neovim: Floating Window</h1><p>Trước khi bắt đầu: Nếu vì lý do gì đó mà bạn quyết định không đọc bài viết này vì bạn đang xài VSCode và thấy nó đủ xịn với bạn rồi, thì hãy suy nghĩ lại, đọc <a href="https://thefullsnack.com/posts/vim-setup-2019.html" target="_blank" rel="noopener">bài này</a>, và tải về <a href="https://github.com/huytd/vim-config" target="_blank" rel="noopener">phiên bản Vim mình đã build</a>. Nó không chỉ có mọi thứ hay ho mà VSCode có, mà còn có nhiều thứ khác xịn hơn mà VSCode không hề có.</p>
<hr>
<p>Neovim từ phiên bản 0.4 có một chức năng cực kì hay ho đó là <code>floating windows</code>, giúp hiển thị một buffer ở bất kì vị trí nào trên màn hình. Nên nhớ là chúng ta đang nói đến Neovim, một editor hoạt động trên terminal, nơi mà mọi thứ chỉ là text và không hề có các khái niệm về giao diện đồ họa.</p>
<p>Sau khi chức năng này được release thì cộng đồng Neovim đã adopt nó khá nhanh, rất nhiều plugin áp dụng nó khá hiệu quả ví dụ như <a href="https://github.com/neoclide/coc.nvim" target="_blank" rel="noopener">coc.nvim</a> hay <a href="https://github.com/Shougo/denite.nvim/" target="_blank" rel="noopener">denite.nvim</a>.</p>
<p>Trong bài viết này, chúng ta sẽ cùng tìm hiểu về floating window thông qua việc build một chức năng giúp cho Neovim có thể mở nhanh một cửa sổ terminal emulator, nằm floating trên màn hình. Mình thường dùng chức năng này khi cần thực hiện nhanh một thao tác nào đó như tạo git branch, push hoặc pull code mà lười xài Tmux.</p>
<p><img src="https://thefullsnack.com/posts/img/vim-float-term/demo.gif" alt=""></p>
<h2 id="Tim-hieu-API-cua-Neovim"><a href="#Tim-hieu-API-cua-Neovim" class="headerlink" title="Tìm hiểu API của Neovim"></a><a href="https://thefullsnack.com/posts/vim-play-with-floating.html#t%C3%ACm-hi%E1%BB%83u-api-c%E1%BB%A7a-neovim" target="_blank" rel="noopener"></a>Tìm hiểu API của Neovim</h2><p>Neovim đã có sẵn terminal emulator built in, đó là lệnh <code>:terminal</code>, khi chạy lệnh này, cửa sổ hiện tại sẽ được thay thế bằng một terminal buffer. Vậy, ý tưởng sẽ là: Tạo một cửa sổ mới, làm cho nó float ở giữa màn hình và chạy lệnh <code>:terminal</code> trong đó.</p>
<p>Theo như <a href="https://neovim.io/doc/user/api.html#api-floatwin" target="_blank" rel="noopener">document về floating windows</a> để tạo một floating window, chúng ta cần hai thứ: 1) một buffer và 2) gọi hàm <code>nvim_open_win()</code> trên buffer đó.</p>
<p>Để tạo mới một buffer, ta có thể dùng hàm <code>nvim_create_buf()</code>. Kết hợp hai hàm này với nhau như thế này:</p>
<pre><code>let buf = nvim_create_buf(v:false, v:true)
let opts = {
  \ &#39;relative&#39;: &#39;cursor&#39;,
  \ &#39;width&#39;: 10, &#39;height&#39;: 2,
  \ &#39;col&#39;: 0, &#39;row&#39;: 1,
  \ &#39;anchor&#39;: &#39;NW&#39;,
  \ &#39;style&#39;: &#39;minimal&#39;
  \ }
let win = nvim_open_win(buf, 0, opts)
</code></pre><p>Nói qua về đối tượng <code>opts</code>, đây là các thông số thiết lập cho cửa sổ sẽ được tạo, có mấy thông số cần nói tới như là:</p>
<ul>
<li><code>relative</code>: cho biết cửa sổ mới sẽ có tọa độ dựa trên đối tượng nào, nếu là <code>editor</code> thì tọa độ sẽ dựa trên toàn bộ màn hình Vim, là <code>win</code> thì tọa độ sẽ dựa trên split window hiện hành, là <code>cursor</code> thì tọa độ sẽ dựa trên vị trí con trỏ hiện tại (dùng trong trường hợp làm autocomplete chẳng hạn).</li>
<li><code>style</code>: hiện chỉ nhận 1 giá trị là <code>minimal</code>, nếu truyền giá trị này thì các thành phần như line number, cursor line,… sẽ được ẩn đi hết.</li>
<li>Mấy thông số như <code>width</code>, <code>height</code> chắc khỏi cần nói tới.</li>
<li>Còn <code>col</code> và <code>row</code> là để chỉ định tọa độ ban đầu của cửa sổ.</li>
</ul>
<p>Cả hai hàm <code>nvim_create_buf()</code> và <code>nvim_open_win()</code> đều trả về id của buffer / floating window vừa tạo ra, chúng ta sẽ dùng các id này khi cần thực hiện các thao tác thiết lập khác.</p>
<h2 id="First-implementation"><a href="#First-implementation" class="headerlink" title="First implementation"></a><a href="https://thefullsnack.com/posts/vim-play-with-floating.html#first-implementation" target="_blank" rel="noopener"></a>First implementation</h2><p>Như vậy, chúng ta đã biết cần phải sử dụng những hàm nào trong API của Neovim để có thể implement chức năng floating terminal. Cụ thể các bước cần thực hiện là:</p>
<ol>
<li>Tạo một buffer mới</li>
<li>Tạo floating window từ buffer này</li>
<li>Khởi động terminal emulator trên buffer vừa tạo với lệnh <code>:terminal</code></li>
</ol>
<p>Ngoài ra, chúng ta muốn cửa sổ được tạo ra phải nằm chính giữa màn hình, trong trường hợp này, Neovim có hai biến <code>&amp;lines</code> và <code>&amp;columns</code> cho chúng ta biết kích thước của toàn bộ màn hình Neovim là bao nhiêu, để có thể tính toán ra các giá trị <code>width</code>, <code>height</code>, <code>row</code> và <code>col</code> thích hợp.</p>
<p><img src="https://thefullsnack.com/posts/img/vim-float-term/layout.png" alt=""></p>
<p>Mặc định, sau khi khởi tạo terminal trong một buffer, thì buffer đó vẫn còn trong chế độ Normal Mode, để tiện hơn chúng ta có thể dùng lệnh <code>startinsert</code>, đưa buffer đó vào chế độ Insert Mode luôn.</p>
<p>Implement như sau (chắc không nói thì các bạn cũng biết là chúng ta đang gõ vào file <code>init.vim</code>):</p>
<pre><code>function! OpenFloatTerm()
  let height = float2nr((&amp;lines - 2) / 1.5)
  let row = float2nr((&amp;lines - height) / 2)
  let width = float2nr(&amp;columns / 1.5)
  let col = float2nr((&amp;columns - width) / 2)
  let opts = {
    \ &#39;relative&#39;: &#39;editor&#39;,
    \ &#39;row&#39;: row,
    \ &#39;col&#39;: col,
    \ &#39;width&#39;: width,
    \ &#39;height&#39;: height,
    \ &#39;style&#39;: &#39;minimal&#39;
    \ }
  let buf = nvim_create_buf(v:false, v:true)
  let win = nvim_open_win(buf, v:true, opts)
  terminal
  startinsert
endfunction
</code></pre><p>Xong rồi, giờ reload Neovim và chạy thử, kết quả sẽ như hình:</p>
<pre><code>:so % | call OpenFloatTerm()
</code></pre><p> <img src="https://thefullsnack.com/posts/img/vim-float-term/first-implementation.png" alt=""></p>
<p>Trông cũng xịn phết! Nhưng mà hơi xấu một tí.</p>
<p>Hiện tại thì Neovim chưa hỗ trợ các thành phần như margin, padding hay border cho floating windows, nên nhìn cái cửa sổ terminal hiện lên chưa đã con mắt cho lắm.</p>
<p>Trong phần tiếp theo, chúng ta sẽ cùng tìm cách fix.</p>
<h2 id="Second-implementation-Cai-tien-giao-dien"><a href="#Second-implementation-Cai-tien-giao-dien" class="headerlink" title="Second implementation: Cải tiến giao diện"></a><a href="https://thefullsnack.com/posts/vim-play-with-floating.html#second-implementation-c%E1%BA%A3i-ti%E1%BA%BFn-giao-di%E1%BB%87n" target="_blank" rel="noopener"></a>Second implementation: Cải tiến giao diện</h2><p>Có một trick, hơi hacky một tí để giải quyết vấn đề padding đó là tạo một cửa sổ to hơn nằm bên dưới cửa sổ terminal hiện tại, trông như thế này:</p>
<p><img src="https://thefullsnack.com/posts/img/vim-float-term/border-layout.png" alt=""></p>
<p>Lưu ý, vì Neovim là môi trường text mode, một ô trên màn hình sẽ là một hình chữ nhật đứng, có tỉ lệ gần như là 1:2, nên việc tính lại tọa độ cũng như kích thước của cửa sổ làm border cũng sẽ được thực hiện với tỉ lệ 1:2.</p>
<p>Tọa độ của cửa sổ border sẽ nằm về phía trên và bên trái của cửa sổ terminal, tương tự kích thước của cửa sổ border cũng sẽ dài và cao hơn cửa sổ terminal:</p>
<p>column border=column main-2row border=row main-1width border=width main+4height border=height main+2column border=column main-2row border=row main-1width border=width main+4height border=height main+2</p>
<p>Hàm <code>OpenFloatTerm()</code> bây giờ sẽ có 2 bước:</p>
<pre><code>function! OpenFloatTerm()
  let height = float2nr((&amp;lines - 2) / 1.5)
  let row = float2nr((&amp;lines - height) / 2)
  let width = float2nr(&amp;columns / 1.5)
  let col = float2nr((&amp;columns - width) / 2)
  &quot; Border Window
  let border_opts = {
    \ &#39;relative&#39;: &#39;editor&#39;,
    \ &#39;row&#39;: row - 1,
    \ &#39;col&#39;: col - 2,
    \ &#39;width&#39;: width + 4,
    \ &#39;height&#39;: height + 2,
    \ &#39;style&#39;: &#39;minimal&#39;
    \ }
  let border_buf = nvim_create_buf(v:false, v:true)
  let border_win = nvim_open_win(border_buf, v:true, border_opts)
  &quot; Main Window
  let opts = {
    \ &#39;relative&#39;: &#39;editor&#39;,
    \ &#39;row&#39;: row,
    \ &#39;col&#39;: col,
    \ &#39;width&#39;: width,
    \ &#39;height&#39;: height,
    \ &#39;style&#39;: &#39;minimal&#39;
    \ }
  let buf = nvim_create_buf(v:false, v:true)
  let win = nvim_open_win(buf, v:true, opts)
  terminal
  startinsert
endfunction
</code></pre><p>Giờ chạy thử xem:</p>
<p><img src="https://thefullsnack.com/posts/img/vim-float-term/border-bug.gif" alt=""></p>
<p>Trông có vẻ thuận con mắt hơn tí rồi. Nhưng mà chúng ta lại gặp bug! Khi đóng cửa sổ terminal thì cửa sổ border nó vẫn còn nằm yên không chịu biến mất.</p>
<p>Nguyên nhân thì rõ ràng, chúng ta chỉ tương tác với cửa sổ terminal mà không làm gì cửa sổ border hết. Để giải quyết vấn đề này, chúng ta có hàm <code>nvim_close_win()</code>, dùng để đóng một cửa sổ bất kì, ta có thể gọi hàm này khi cửa sổ terminal bị đóng.</p>
<p>Làm sao để biết khi nào cửa sổ terminal bị đóng?</p>
<p>Lại tra tài liệu, chúng ta sẽ thấy <a href="https://neovim.io/doc/user/autocmd.html#TermClose" target="_blank" rel="noopener">sự kiện TermClose</a> được gọi khi chúng ta rời khỏi chế độ Terminal. Để bắt sự kiện này, ta dùng lệnh <code>autocmd</code>, như thế này:</p>
<pre><code>autocmd TermClose * ++once :q | call nvim_win_close(&lt;window-id&gt;, v:true)
</code></pre><p>Tham số <code>*</code> ở đây có nghĩa là lệnh áp dụng cho mọi buffer, tham số <code>++once</code> sẽ làm cho lệnh này chỉ thực thi 1 lần. Đồng thời, khi terminal bị tắt, Neovim sẽ không đóng buffer chứa terminal đó đi, mà hiện dòng chữ <code>[Process exited 0]</code>, chúng ta phải gửi thêm lệnh <code>:q</code> để đóng nó.</p>
<p>Đây là implementation hoàn chỉnh:</p>
<pre><code>function! OpenFloatTerm()
  let height = float2nr((&amp;lines - 2) / 1.5)
  let row = float2nr((&amp;lines - height) / 2)
  let width = float2nr(&amp;columns / 1.5)
  let col = float2nr((&amp;columns - width) / 2)
  &quot; Border Window
  let border_opts = {
    \ &#39;relative&#39;: &#39;editor&#39;,
    \ &#39;row&#39;: row - 1,
    \ &#39;col&#39;: col - 2,
    \ &#39;width&#39;: width + 4,
    \ &#39;height&#39;: height + 2,
    \ &#39;style&#39;: &#39;minimal&#39;
    \ }
  let border_buf = nvim_create_buf(v:false, v:true)
  let s:border_win = nvim_open_win(border_buf, v:true, border_opts)
  &quot; Main Window
  let opts = {
    \ &#39;relative&#39;: &#39;editor&#39;,
    \ &#39;row&#39;: row,
    \ &#39;col&#39;: col,
    \ &#39;width&#39;: width,
    \ &#39;height&#39;: height,
    \ &#39;style&#39;: &#39;minimal&#39;
    \ }
  let buf = nvim_create_buf(v:false, v:true)
  let win = nvim_open_win(buf, v:true, opts)
  terminal
  startinsert
  &quot; Hook up TermClose event to close both terminal and border windows
  autocmd TermClose * ++once :q | call nvim_win_close(s:border_win, v:true)
endfunction
</code></pre><p>Và đây là thành phẩm:</p>
<p><img src="https://thefullsnack.com/posts/img/vim-float-term/final.gif" alt=""></p>
<hr>
<p>Hy vọng qua bài viết này, các bạn sẽ hiểu được phần nào chức năng Floating Windows của Neovim, cũng như những ứng dụng mà nó mang lại. Từ đầu tới giờ viết dông dài vậy thôi chứ nếu bạn chỉ xài Vim như là một user bình thường thì không cần đọc bài này đâu.</p>

      
      
    </div>
    

    <!-- <footer class="article-footer">
      <a data-url="toandn96.github.io/2019/11/25/Flutter-tutorials-Get-started-Install%20copy%2025/" data-id="ck3f7ae6l001wzcj2dho802xk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Fight/" rel="tag">Fight</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Injury/" rel="tag">Injury</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Shocking/" rel="tag">Shocking</a></li></ul>

    </footer> -->
  </div>
  <!-- 
  
<nav id="article-nav">
  
  
    <a href="/2019/11/25/Flutter-tutorials-Get-started-Install/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Flutter tutorials Get started - Install</div>
    </a>
  
</nav>

   -->
</article>

</section>
        
          <aside id="sidebar" >
  <div style="display: flex;justify-content: center;align-items: center;height: 100px;">
    <div id="header-home">
      <picture>
        <a href="/">
          <img class="img-header" src="https://raw.githubusercontent.com/toandn96/source/master/doug.png" />
        </a>
      </picture>
    </div>
  </div>

  
  
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Sports/">Sports</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Sports/Baseball/">Baseball</a></li></ul></li></ul>
    </div>
  </div>


  
  <!-- 
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fight/" rel="tag">Fight</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Injury/" rel="tag">Injury</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shocking/" rel="tag">Shocking</a></li></ul>
    </div>
  </div>
 -->

  
  <!-- 
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Fight/" style="font-size: 10px;">Fight</a> <a href="/tags/Injury/" style="font-size: 10px;">Injury</a> <a href="/tags/Shocking/" style="font-size: 10px;">Shocking</a>
    </div>
  </div>
 -->
  
  
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">tháng 11 2019</a></li></ul>
    </div>
  </div>


  
  <!-- 
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/11/25/Flutter-tutorials-Get-started-Install%20copy%2025/">Cách mạng 0.4 của Neovim: Floating Window</a>
          </li>
        
          <li>
            <a href="/2019/11/25/Flutter-tutorials-Get-started-Install/">Flutter tutorials Get started - Install</a>
          </li>
        
          <li>
            <a href="/2019/11/25/Flutter-tutorials-Get-started-Install%20copy%202/">Flutter tutorials Get started - Install</a>
          </li>
        
          <li>
            <a href="/2019/11/25/Flutter-tutorials-Get-started-Install%20copy%203/">Flutter tutorials Get started - Install</a>
          </li>
        
          <li>
            <a href="/2019/11/25/Flutter-tutorials-Get-started-Install%20copy%204/">Flutter tutorials Get started - Install</a>
          </li>
        
      </ul>
    </div>
  </div>
 -->
  
</aside>
        
      </div>
      <!-- <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 toandn96<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer> -->
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>